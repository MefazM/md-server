require 'player/player'

module Player
  # TODO: Fix sql injection problem
  class PlayerFactory
    def self.find_or_create login_data
      Celluloid::Logger::info "Player logging in (Token = #{login_data[:token]})"

      authentication = Storage::Mysql::Pool.connections_pool.with do |mysql|
        mysql.select("SELECT * FROM authentications WHERE token = '#{login_data[:token]}'").first
      end

      player_id = authentication.nil? ? self.create_player(login_data) : authentication[:player_id]

      self.get_player_data(player_id)
    end

    private

    def self.create_player login_data
      player_id = Storage::Mysql::Pool.connections_pool.with do |mysql|

        mysql.insert('players', {:email => login_data[:email], :username => login_data[:name]})

        id = mysql.last_inser_id

        raise "Player is not created! \n #{login_data.inspect}" if id == -1

        data = {:player_id => id, :provider => login_data[:provider],:token => login_data[:token]}
        mysql.insert('authentications', data)

        id
      end

      Celluloid::Logger::info "New player created. id = #{player_id}"

      Storage::Redis::Pool.connections_pool.with do |redis|
        redis.connection.hset("players:#{player_id}:resources", "last_harvest_time", Time.now.to_i)
        redis.connection.hset("players:#{player_id}:resources", 'coins', 0)
        redis.connection.hset("players:#{player_id}:resources", 'harvester_storage', 0)
      end

      player_id
    end

    def self.get_player_data player_id
      player_data = Storage::Mysql::Pool.connections_pool.with do |mysql|
        mysql.select("SELECT * FROM players WHERE id = '#{player_id}' ").first
      end

      raise "Authentication find, but player data is not found!" if player_data.nil?

      # return PlayerActor.new(player_id, player_data[:email], player_data[:username])

      return player_id, player_data[:email], player_data[:username]
    end

  end
end
